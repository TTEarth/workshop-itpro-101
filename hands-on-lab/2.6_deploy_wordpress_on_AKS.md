# 2.6 Azure Kubernetes Service에 Wordpress 배포
Docker Host를 관리하기 위해서는 여러가지 방법이 있다. Azure Container Service에서는 DC/OS와 Docker Swarm, 그리고 Kubernetes 클리스터를 구성하고 관리해준다. 그 중 Kubernetes의 경우 관리 서버를 가상 컴퓨터로 만들지 않고 Azure에서 직접 관리해 주는 ACSv2라고 할 수 있는 AKS라는 서비스가 나왔으며, 이는 사용자 입장에서 실 서비스에 포함되는 가상 컴퓨터만 운용하면 되기 때문에 과금적으로 매우 유리하다.

여기서는 AKS를 구성해 보고 ACR에 있는 wordpress image를 이용하여 AKS에 wordpress를 배포한다.

## AKS 구성하기
1. [Azure 웹 콘솔](https://portal.azure.com)에 접속한다.

2. 좌측 메뉴에서 **리소스 만들기**를 클릭한다.

3. **새로 만들기** 블레이드 창이 뜨면 상단의 검색창에 `kubernetes service`를 입력한 후 엔트키를 입력한다.

4. 검색된 화면에서 `Kubernetes Service`를 찾아 클릭한다. 클릭하기 전 **게시자** 컬럼에 `Microsoft`로 되어있는지 다시 한 번 확인하자.

5. **Kubernetes Service** 블레이드 창이 뜨면 가볍게 내용을 확인한 후 하단에 **만들기** 버튼을 클릭한다.

6. **Kubernetes 클러스터 만들기** 블레이드 창이 뜨면 상단에 **기본 사항**부터 **인증**, **네트워킹**, **모니터링**, **태그**, **검토+만들기**를 탭 개념으로 차례대로 선택하여 입력한다. 우선 **기본 사항**을 클릭하여 아래와 같이 입력한다.
    - `구독`: AKS 클러스터를 생성할 구독을 선택한다.
    - `리소스 그룹`: AKS 클러스터를 생성할 리소스 그룹을 선택한다. 여기서는 `krazure-aks`로 새로 생성한다.
    - `Kubernetes 클러스터 이름`: AKS 클러스터의 이름을 입력한다. 여기서는 `krauzre-aks`로 입력한다.
    - `지역`: AKS 클러스터를 생성할 지역을 선택한다. 여기서는 **아시아 남동부**를 선택한다.
    - `Kubernetes 버전`: AKS 클러스터의 버전을 선택한다. 여기서는 **1.11.1**을 선택한다.
    - `DNS 이름 접두사`: AKS 클러스터를 관리할 때 사용할 DNS 이름을 입력한다. 여기서는 자주 사용하는 이름 또는 ID를 이용하여 `krazure-aks`을 입력한다.
    - `노드 크기`: AKS 클러스터의 노드인 가상 컴퓨터의 크기를 선택한다. 여기서는 기본 값을 쓴다.
    - `노드 개수`: AKS 클러스터의 노드인 가상 컴퓨터의 개수를 선택한다. 여기서는 기본 값을 쓴다.

7. **기본 사항**을 전부 입력했다면, 상단에 **인증**을 클릭하여 아래와 같이 입력한다.
    - `서비스 사용자`: AKS 클러스터를 생성할 시 AAD의 서비스 사용자를 설정한다. AAD 서비스 사용자를 새로 생성하려면, 현재 계정에 AAD 접근 권한이 있어야 한다. 여기서는 기본 값은 __(새) 기본 서비스 사용자__ 를 그대로 사용한다.

8. **인증**을 전부 입력했다면, 상단에 **네트워킹**을 클릭하여 아래와 같이 입력한다.
    - `http 응용 프로그램 라우팅`:
    - `네트워크 구성`: AKS 클러스터의 네트워크 구성을 설정한다. 여기서는 **고급**을 선택한다.
    - `가상 네트워크`: AKS 클러스터를 생성할 가상 네트워크를 선택한다. 여기서는 `krazure-vnet`을 선택한다.
    - `서브넷`: AKS 클러스터를 생성할 서브넷을 선택한다. 여기서는 `krazure-subnet`을 선택한다.
    - `Kubernetes 서비스 주소 범위`: AKS 클러스터 IP를 할당하는 CIDR를 입력한다. 이는 Subnet과 중복이 되면 안되므로 여기서는 `10.0.3.0/24`를 입력한다.
    - `Kubernetes DNS 서비스 IP 주소`: AKS DNS 서비스 IP 주소를 입력한다. 이는 `Kubernetes 서비스 주소 범위` 안에 있어야 하며 여기서는 `10.0.3.10`을 입력한다.
    - `Docker 브리지 주소`: Docker에서 사용하는 네트워크 대역을 정의한다. 이 네트워크는 가상 네트워크와 전혀 상관없는 대역을 설정해야 한다. 여기서는 `172.17.0.1/16`을 사용한다.

9. **네트워킹**을 전부 입력했다면, 상단에 **모니터링**을 클릭하여 아래와 같이 입력한다.
    - `컨테이너 모니터링 사용`: AKS의 Log를 Log Analytics 작업에 넣어 분석한다. 여기서는 **예**를 선택한다.
    - `Log Analytics 작업 영역`: AKS의 Log를 넣을 Log Analytics 작업 영역을 입력한다. 우리는 Log Analytics 작업 영역을 만든 적이 없기 때문에 여기서는 기본 값을 쓴다.

10. **네트워킹**을 전부 입력했다면, 하단에 **검토+만들기** 또는 상단에 **검토+만들기**를 클릭하여 설정의 유효성 검사를 한다. 유효성 검사가 통과하면 하단에 **만들기**버튼을 클릭하여 AKS 클러스터를 만든다.
    > [!메모]
    >
    > AKS 배포엔 약 15분 정도가 소요된다.

# AKS CLI를 이용하여 wordpress 배포
11. Azure portal의 우측 상단에 `>_` 아이콘을 클릭하여 Azure Cloud Shell을 실행한다.
    > [!메모]
    >
    > Azure cloud Shell을 생성하면 `cloud-shell-storage-<지역>`이라는 리소스 그룹이 생성된다. 이 리소스 그룹에는 Cloud Shell 이미지 파일 blob에 담겨있다.

12. 다음 명령어를 실행하여 `kubectl`을 사용할 수 있도록 구성한다.
    ```Azurecli
    $ az aks get-credentials --resource-group krazure-aks --name krazure-aks
    ```

13. 다음 명령어를 실행하여 AKS에 연결된 Node를 확인한다.
    ```Azurecli
    $ kubectl get nodes
    ```
    ```결과
    $ kubectl get nodes
    NAME                       STATUS    ROLES     AGE       VERSION
    aks-agentpool-40342721-0   Ready     agent     14m       v1.11.1
    aks-agentpool-40342721-1   Ready     agent     14m       v1.11.1
    aks-agentpool-40342721-2   Ready     agent     14m       v1.11.1
    ```

14. 