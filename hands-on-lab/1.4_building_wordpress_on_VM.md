# 1.4 Ubuntu 16.04 가상 컴퓨터에 Wordpress 설치
Azure에서는 가상 컴퓨터를 만들 때 정말 쉽게 만들 수 있도록 **생성시 모든 것을 만들 수 있도록** 되어있다. 하지만, 기본적으로 네트워크를 디자인하고, Log를 한 곳에 모으는 것 같이 아키텍처를 그리고 리소스를 만드려면 앞서 진행한 `1.1과 1.3`의 작업이 선행 되어야 보다 쉽게 아키텍처에 그려진 대로 서비스를 구축할 수 있다.

이번 내용에서는 Azure에 Ubuntu 16.04를 만들 때 가용성 집합을 사용하고 운영체제 디스크는 관리 디스크를 사용하여 만들어 본다. 가상 컴퓨터를 만든 후 Wordpress를 구성하는 스크립트를 실행한다.

가상 컴퓨터(VM)에 대해 좀 더 상세히 알아보고 싶으신 분은 [Azure Linux 가상 컴퓨터 문서](https://docs.microsoft.com/ko-kr/azure/virtual-machines/linux/)를 참고한다.

## 웹 콘솔에서 Ubuntu 16.04 가상 컴퓨터 만들기
1. [Azure 웹 콘솔](https://portal.azure.com)에 접속한다.

2. 좌측 메뉴에서 **리소스 만들기**를 클릭한다.

3. **새로 만들기** 블레이드 창이 뜨면 상단의 검색창에 `ubuntu 16.04`를 입력한 후 엔트키를 입력한다.

4. 검색된 화면에서 `Ubuntu Server 16.04 LTS`를 찾아 클릭한다. 클릭하기 전 **게시자** 컬럼에 `Canonical`로 되어있는지 다시 한번 확인하자.

5. **Ubuntu Server 16.04 LTS** 블레이드 창이 뜨면 가볍게 내용을 확인한 후 하단에 **배포 모델 선택**을 **Resource Manager**로 선택한 후 **만들기**버튼을 클릭한다.

6. **가상 머신 만들기** 블레이드 창이 뜨면 **1. 기본 사항**부터 **4. 요약**까지 메뉴가 나오며 각 단계별 설정할 수 있는 블레이드 창이 뜬다.
    > [!메모]
    >
    > **가상 컴퓨터 만들기** 블레이드에 나오는 **1. 기본 사항**부터 **4. 요약** 까지의 내용은 언제든 선택하여 이동하실 수 있습니다.

7. **기본 사항**에 대해서는 아래와 같이 입력한 후 **확인**버튼을 클릭한다.
    - `이름`: 표시 될 가상 컴퓨터 이름을 입력한다. 여기서는 `krazure-wp`를 입력한다.
    - `VM 디스크 유형`: **SSD**는 프리미엄 저장소를 뜻하며, **HDD**는 일반 저장소를 뜻한다. 여기서는 **SSD**를 선택한다.
    - `사용자 이름`: Linux에 로그인 할 계정을 입력한다. 여기서는 `krazure`를 입력한다.
    - `인증 형식`: **SSH 공개 키** 또는 **암호**방식의 로그인을 선택한다. 여기서는 **SSH 공개 키**를 선택한다.
    - `SSH 공개 키`: 공개키 파일의 내용을 입력한다. SSH 공개키를 만드는 방법을 모르면 [여기](../key-pair/vm_publickey.pem)를 참고하여 공개키를 입력한다.
    - `Azure Active Directory를 사용하여 로그인(미리 보기)`: AAD 계정을 이용하여 OS에 로그인 하는 설정이다. 여기서는 **사용 안 함**을 선택한다.
    - `구독` : 가상 네트워크를 생성할 구독을 선택한다.
    - `리소스 그룹` : 저장소 계정을 만들 리소스 그룹을 선택한다. **기존 그룹 사용**을 선택한 후 앞서 생성한 `krazure-sg`를 선택한다.
    - `위치` : 가상 네트워크를 생성할 지역을 선택한다. 여기서는 `아시아 남동부`를 선택한다.

8. `크기` 블레이드 창이 뜨면 원하는 가상 컴퓨터 크기를 선택한 후 하단의 **선택**을 클릭합니다. 여기서는 `B1ms`을 선택한다.

9. `설정` 블레이드 창이 뜨면 아래와 같이 입력한 후 **확인**버튼을 클릭한다.
    - `가용성 영역`: 가용성 영역을 사용할 시 선택한다. 여기서는 가용성 집합을 사용할 것이기 때문에 **없읍**을 선택한다.
    - `가용성 집합`: 가상 컴퓨터의 가용성 집합을 설정한다. **없음**을 클릭하면 **가용성 집합 변경** 블레이드 창이 뜬다. 여기에서 **새로 만들기**를 클릭하고 아래와 같이 입력한 후 하단에 **확인**을 클릭한다.
        - `이름`: 표시 될 가용성 집합의 이름을 입력한다. 여기서는 `krazure-as`로 입력한다.
        - `장애 도메인`: 설정할 장애 도메인의 개수 입니다. 기본 값을 사용한다.
        - `업데이트 도메인`: 설정할 업데이트 도메인 입니다. 기본 값을 사용한다.
        - `관리 디스크 사용`: 자동으로 설정된다.
            > [!메모]
            >
            > 가용성 집합은 관리 디스크의 사용 여부에 따라 다르게 적용된다. 예를 들어 가용성 집합이 관리 디스크를 사용하도록 설정한 후 만들게 되면, 관리 디스크를 사용하지 않는 가상 컴퓨터는 해당 가용성 집합에 포함 될 수 없다.
    - `관리 디스크 사용`: **관리 디스크**를 사용할 시 선택한다. 여기서는 **예**를 선택한다.
    - `OS 디스크 크기`: 가상 컴퓨터의 OS용량을 선택한다. 여기서는 기본 값을 사용한다.
    - `가상 네트워크`: **가상 컴퓨터**의 **네트워크 인터페이스**가 연결 될 **가상 네트워크**를 선택합니다. 미리 생성한 **가상 네트워크**를 선택합니다.
        > [!메모]
        >
        > `저장소 계정`에서 설명한 것과 같이 배치 작업을 수행할 때 문제가 될 수 있습니다.

    - `서브넷`: **가상 컴퓨터**의 **네트워크 인터페이스**가 연결 될 **서브넷**를 선택합니다. 미리 생성한 **서브넷**를 선택합니다.
        > [!메모]
        >
        > `저장소 계정`에서 설명한 것과 같이 배치 작업을 수행할 때 문제가 될 수 있습니다.

    - `공용 IP 주소`: 공인 IP가 필요하다면 설정합니다. 여기서는 **공인 IP**를 **동적**으로 설정하도록 하겠습니다.
        - `이름`: 표시될 **공용 IP 주소**의 이름입니다.
        - `할당`: 공인 IP를 동적으로 할당 받을지 정적으로 할당 받을지를 선택합니다. 여기서는 **동적**으로 선택합니다.
        > [!메모]
        >
        > **동적**할당은 가상 컴퓨터가 꺼졌다가 켜질 때 마다 공인 IP를 새롭게 받아옵니다.
        >
        > **정적**할당은 가상 컴퓨터가 꺼졌다가 켜지더라고 공인 IP가 변경되지 않습니다.

    - `네트워크 보안 그룹(방화벽)`: **가상 컴퓨터**의 **네트워크 인터페이스**에 연결될 **네트워크 보안 그룹**을 선택합니다. 여기서는 기존에 자동 생성되는 **네트워크 보안 그룹**을 그대로 사용하겠습니다.
    - `확장`: **가상 컴퓨터**를 만들 때 사용할 기능을 선택 합니다. 대부분이 제품을 설치하는 옵션이며, 최초 **가상 컴퓨터** 생성 시 실행해야 할 **스크립트**를 지정할 수 있습니다. 여기서는 **확장을 추가하지 않겠습니다.**
    - `부트 진단`: **가상 컴퓨터**가 부팅될 때 로그를 생성할 수 있습니다. 실제 서비스 시에 해당 옵션이 꺼져 있으면 문제 추적에 어려움이 있을 수 있어 **사용하는 것이 권장**입니다. 여기서는 **사용 안 함**을 선택 하겠습니다.
    - `게스트 OS 진단`: **가상 컴퓨터**의 운영체제의 문제에 대한 추적을 할 수 있도록 로그를 생성할 수 있습니다. 실제 서비스 시에 해당 옵션이 꺼져 있으면 문제 추적에 어려움이 있을 수 있어 **사용하는 것이 권장**입니다. 여기서는 **사용 안 함**을 선택 하겠습니다.
    - `진단 저장소 계정`: 위의 `부트 진단`과 `게스트 OS 진단` 옵션 중 하나라도 **사용**할 시 활성화 됩니다. 위의 `저장소 계정`옵션과 동일한 **저장소 계정**을 사용할 수 없으며, **프리미엄 저장소**도 사용할 수 없습니다.
        > [!메모]
        >
        > `저장소 계정`에서 설명한 것과 같이 배치 작업을 수행할 때 문제가 될 수 있습니다.

10. **요약** 블레이드가 뜨면 지금까서 설정한 설정들을 확인하고 하단에 **확인** 버튼을 클릭하여 **가상 컴퓨터**를 만듭니다.
    > [!메모]
    >
    > 상단에 **유효성 검사 통과**가 나올 시 **가상 컴퓨터**를 생성할 수 있으며 만약 다른 메세지가 나오게 된다면 **제한 사항**에 문제가 있을 수 있습니다. **제한 사항**에 대해서는 다음 [URL](https://docs.microsoft.com/ko-kr/azure/azure-subscription-service-limits#networking-limits)을 참고해 주시기 바랍니다.

11. 다음을 참고하여 Ubuntu Server에 접속하여 [Apache 설치](#apache-설치)를 합니다.

## ## Azure CLI 2.0을 이용하여 Ubuntu 16.04 가상 컴퓨터 만들기
1. 각 운영체제에 맞는 CLI 창을 실행 합니다.

2. 다음 명령을 사용하여 `Azure CLI 2.0`을 인증 합니다.
    ```Azurecli
    az login
    ```

3. 명령어 실행 후 웹 브라우저로 출력된 [URL](https://aka.ms/devicelogin)에 접속합니다.

4. **Devicr Login** 페이지가 뜨면 출력된 9자리의 코드를 복사하여 입력합니다.

5. **Microsoft Azure Cross-platform Command Line Interface** 라는 메세지와 함께 생성된 화면에서 **Continue**를 클릭합니다.

6. 로그인 창이 뜨면 Azure 계정으로 로그인 합니다.

7. **Microsoft Azure Cross-platform Command Line Interface** 이라는 메세지와 함께 인증이 완료되었다는 창이 뜨면 웹 브라우저를 닫고 다시 CLI 창으로 돌아오면 인증이 완료된 것을 확인할 수 있습니다.
    > [!메모]
    >
    > JSON형식으로 출력된 값이 두 개 이상인 경우 로그인 한 계정에 연결된 구독(subscription)이 두 개 이상인 경우 입니다. 이 때 아래와 같은 명령어를 사용하여 특정 구독을 사용하겠다는 정의를 별도로 해 주어야 합니다.
    > ```Azurecli
    > az account set --subscription "<Subscription ID>"
    > ```

8. 다음 명령을 사용하여 **Windows Server 2016 DataCenter 이미지**를 찾습니다.
    ```Azurecli
    az vm image list -f ubuntu
    ```

9. 다음 명령을 사용하여 생성한 **가상 네트워크**와 **저장소 계정**을 조회합니다.
    ```Azurecli
    az network vnet list
    az storage account list
    ```

10. 다음 명령을 사용하여 **가상 컴퓨터**를 만듭니다. 옵션에 대한 자세한 설명은 [Azure CLI 2.0 문서](https://docs.microsoft.com/en-us/cli/azure/vm#create)를 참고하시기 바랍니다.
    - bash
    ```bash
    vm_name=<표시 될 가상 컴퓨터 이름>
    username=<OS에서 로그인 할 계정 이름>
    password=<OS에서 로그인 할 비밀번호>
    resource_group=<리소스 그룹 이름>
    vm_image=<`8번`에서 검색한 이미지의 "urnAlias" 값>
    storage_account=<생성된 저장소 계정 이름>
    vnet_name=<생성된 가상 네트워크 이름>
    subnet_name=<생성된 서브넷 이름>
    region=<가상 컴퓨터를 생성할 지역>

    az vm create -n $vm_name \
    -g $resource_group \
    --image $vm_image \
    --admin-username $username \
    --admin-password $password \
    --size Standard_F1 \
    --use-unmanaged-disk \
    --storage-account $storage_account \
    --vnet-name $vnet_name \
    --subnet $subnet_name \
    --public-ip-address-allocation dynamic \
    --nsg-rule SSH \
    -l $region
    ```

    - command
    ```bash
    set vm_name=<표시 될 가상 컴퓨터 이름>
    set username=<OS에서 로그인 할 계정 이름>
    set password=<OS에서 로그인 할 비밀번호>
    set resource_group=<리소스 그룹 이름>
    set vm_image=<`8번`에서 검색한 이미지의 "urnAlias" 값>
    set storage_account=<생성된 저장소 계정 이름>
    set vnet_name=<생성된 가상 네트워크 이름>
    set subnet_name=<생성된 서브넷 이름>
    set region=<가상 컴퓨터를 생성할 지역>

    az vm create -n %vm_name% \
    -g %resource_group% \
    --image %vm_image% \
    --admin-username %username% \
    --admin-password %password% \
    --size Standard_F1 \
    --use-unmanaged-disk \
    --storage-account %storage_account% \
    --vnet-name %vnet_name% \
    --subnet %subnet_name% \
    --public-ip-address-allocation dynamic \
    --nsg-rule RDP \
    -l %region%
    ```

    > [!메모]
    >
    > 가상 컴퓨터 크기에 대한 옵션인 `--size`에 대한 값은 [부록1 가상 컴퓨터 크기](https://github.com/krazure/hands-on-lab/blob/master/%EB%B6%80%EB%A1%9D/%EB%B6%80%EB%A1%9D1%20%EA%B0%80%EC%83%81%20%EC%BB%B4%ED%93%A8%ED%84%B0%20%ED%81%AC%EA%B8%B0.md)를 참고하세요.

11. 다음을 참고하여 Ubuntu Server에 접속하여 [Apache 설치](#Apache-설치)를 합니다.

## Apache 설치
1. Ubuntu Server에 접속하여 로그인을 합니다.
    - putty를 이용하여 접속하시는 분은 다음 [0.3 putty client로 linux 접속하기](https://github.com/krazure/hands-on-lab/blob/master/SAL%201704%20IaaS%20%EC%95%8C%EC%95%84%EB%B3%B4%EA%B8%B0%20-%20Global%20Azure%20BootCamp%202017/0.3%20Putty%20client%EB%A1%9C%20Linux%20%EC%A0%91%EC%86%8D%ED%95%98%EA%B8%B0.md)를 참고 바랍니다.

2. 다음 명령을 사용하여 **Apache 2**를 설치합니다.
    ```bash
    sudo apt-get update && sudo apt-get install -y apache2
    ```

3. 설치가 완료되면 정상적으로 서비스가 올라왔는지 확인합니다.
    ```bash
    sudo service apache2 status
    ```

4. [Azure 웹 콘솔](https://portal.azure.com)에 접속합니다.
    - Azure CLI 2.0을 이용하여 네트워크 보안 그룹을 수정하시려면 `10번`의 [!메모]로 이동하여 주세요.

5. 좌측 메뉴에서 **리소스 그룹**을 선택합니다.
    - 좌측 메뉴에 **리소스 그룹**이 없다면, 하단의 More Service를 선택 한 후 **resources**을 검색하여 선택합니다.

6. 접속한 Ubuntu Server가 있는 **리소스 그룹**을 선택합니다.

7. 선택한 **리소스 그룹**의 블레이드가 뜨면 접속한 Ubuntu Server의 **네트워크 보안 그룹**을 선택합니다.

8. 선택한 **네트워크 보안 그룹**에서 좌측 메뉴에 **인바운드 보안 규칙**을 선택합니다.

9. 상단에 **추가**버튼을 클릭합니다.

10. **인바운드 보안 규칙 추가** 블레이드가 뜨면 아래와 같이 입력한 후 **확인** 버튼을 클릭합니다.
    - `이름`: 표시 될 인바운드 규칙 이름을 입력합니다. 예) HTTP
    - `우선 순위`: 정책을 적용받는 우선 순위 입니다. 기본 값을 사용합니다.
    - `소스`: **Any**는 누구나 접근할 수 있는 옵션이며, **CIDR block**은 지정한 CIDR 범위에서만 접근하는 옵션이고, **Tag**를 선택하면 `소스 태그`라는 옵션이 추가되어 해당 **Tag**를 가진 네트워크가 접근할 수 있는 옵션입니다. 여기서는 **Any**를 선택하겠습니다.
    - `서비스`: 기본 값인 **사용자 지정**은 `프로토콜`과 `포트 범위`를 사용자가 직접 입력하여 설정할 수 있는 옵션입니다. 여기서는 **HTTP**를 찾아 선택합니다.
    - `프로토콜`: `서비스`를 선택하면 자동으로 선택 불가능하게 됩니다.
    - `포트 범위`: `서비스`를 선택하면 자동으로 선택 불가능하게 됩니다.
    - `작업`: **거부**는 위에 설정한 설정 대로 접근을 차단할 때 씁니다. 여기서는 **허용**을 선택하여 위에 설정한 설정을 허용 합니다.

    > [!메모]
    >
    > Azure CLI 2.0 실행 시 아래와 같이 **네트워크 보안 그룹**에 정책을 설정할 수 있습니다.
    > ```azurecli
    >az network nsg rule create -g <리소스 그룹 이름> \
    >-n HTTP \
    >--nsg-name <네트워크 보안 그룹 이름> \
    >--priority 1010 \
    >--source-address-prefix '*' \
    >--source-port-range '*' \
    >--destination-address-prefix '*' \
    >--destination-port-range 80 \
    >--access Allow \
    >--protocol Tcp
    > ```

11. **리소스 그룹**의 블레이드로 돌아와 Ubuntu Server의 **공용 IP 주소**를 선택하여 IP 주소를 확인한 후 웹 브라우저에 접속합니다.
    > [!메모]
    >
    > Azure CLI 2.0 실행 시 아래와 같이 공인 IP를 확인 할 수 있습니다.
    > ```azurecli
    >az vm list-ip-addresses
    > ```
